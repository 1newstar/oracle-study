# Oracle Recovery Manager 恢复管理器(RMAN)

[SQL-DEMO-RMAN](../../sql_demo/backup/rman.sql)

RMAN可以管理整个周期：将数据库从一级存储备份到二级存储，并将备份从二级存储迁移到三级存储。
可以将这样的系统实现为在故障之后能接近瞬间恢复，同时能在必要时及时恢复数据库。

打开状态的备份只能在数据库处于归档日志模式下才能进行。
如果数据库处于非归档日志模式，则只能进行关闭状态的备份，并且(如果使用RMAN)数据库必须为加载模式，然后执行干净关闭。
RMAN脱机备份，数据库必须处于MOUNT模式，只能脱机备份非归档日志数据库，可以是增量备份。
RMAN从不备份联机重做日志文件或临时文件。它将备份数据文件、归档日志文件、控制文件和spfile文件。
在创建备份集或压缩的备份集时，RMAN不备份未分配到段的块。这会节省大量的空集。
如果没有运行级别0备份，那么第一次级别1差异备份或累积备份将实际执行级别0备份。
可在不执行还原操作的情况下立即使用映像副本。备份到备份集的文件在使用前必须由RMAN从备份集中还原。
默认加密要求使用一个钱夹和AES 128算法。或者指定一个口令或更长的密钥。
RMAN将总是优先于应用重做数据来应用增量备份(如果可用)。
关键数据文件的丢失并不意味着数据丢失，但意味着时间的丢失。
如果缺失归档日志或当前联机重做日志文件组的所有副本缺失，那么必须执行不完全恢复。
跳过坏事务的恢复而恢复所有其他工作是不可能的。



## 配置 Oracle Recovery Manager

- RMAN 常用命令

```oracle
list
report
delete
```
`DELETE EXPIRED`命令不删除任何文件，它只更新RMAN存储库。`DELETE OBSOLETE`命令将删除文件并相应地更新存储库。

- 管理 flash_recovery_area
- 创建 RMAN catalog
- 控制文件自动备份


## 使用 Oracle Recovery Manager

- RMAN 交互方式
- “干净”备份
- 备份
- 管理备份数据
- 启、停块跟踪


## 数据恢复顾问 Data Recovery Advisor

诊断修复工具。

DRA只能用于单实例数据库的环境。它不能用于RAC集群数据库，也不能用于Data Guard备用数据库。

使用DRA流程：

- 访问数据故障
- 列出故障
- 提供修复建议
- 执行修复

如果不首先要求DRA列出故障，则DRA不会生成任何建议。对于最近一次列出之后发生的任何故障或修复的任何故障，DRA不提供任何建议。


## 高级功能

### 恢复目录

RMAN存储库总是存在于RMAN目标数据库控制文件中，但是它只能恢复由`CONTROLFILE_RECORD_KEEP_TIME`参数所指定的数据。
恢复目录是一个额外的存储区，它可以无限期地保留数据。

到目标数据库的RMAN连接通常是作为SYS用户发起的，因为一般需要发出启动和关闭命令。不需要指定`AS SYSDBA`--该工具假定如此。

RMAN可执行文件的版本必须与目标数据库相同，并且低于或等于用来创建目录的RMAN版本。

### 存储脚本


### 使用RMAN创建数据库

> `DUPLICATE`命令完成的工作

- 为复制数据库创建控制文件。
- 将目标数据文件还原到复制数据库，或直接从运行中的数据库复制。
- 执行不完整恢复，一直恢复到最后的归档重做日志文件为止。
- 关闭然后重启辅助实例。
- 使用`RESETLOGS`选项打开辅助数据库，以创建联机重做日志文件。
- 为辅助数据库生成新的DBID。

### 表空间时间点恢复(TSPITR)


### 虚拟专用目录

有助于多个DBA之间的职责分工。
一个或多个虚拟专用目录共享同一个基本恢复目录。

### 为异步I/O配置RMAN

- 将初始化参数`BACKUP_TAPE_IO_SLAVES`设置为TRUE，以便为异步操作配置磁带备份。
- 设置初始化参数`DBWR_IO_SLAVES`来分配4个从属备份磁盘I/O进程，以便模拟RMAN异步I/O操作。
- 使用动态性能视图`V$BACKUP_ASYNC_IO`来监视异步RMAN操作。


